name: Auto Version Tag

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: version-tag-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  create-version-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version bump type from commits
        id: bump-type
        run: |
          set -eu
          git fetch --tags --force
          latest_tag="$(git tag --list 'v*' --sort=-v:refname | head -n 1)"
          if [ -z "$latest_tag" ]; then
            latest_tag="v0.0.0"
          fi

          commit_log="$(git log --format='%s%n%b' "${latest_tag}..HEAD" || true)"
          bump_type="patch"
          if printf '%s\n' "$commit_log" | grep -Eq 'BREAKING CHANGE|!:'; then
            bump_type="major"
          elif printf '%s\n' "$commit_log" | grep -Eq '^feat(\(.+\))?:'; then
            bump_type="minor"
          fi

          {
            echo "latest_tag=$latest_tag"
            echo "bump_type=$bump_type"
          } >> "$GITHUB_OUTPUT"

      - name: Calculate next version
        id: version
        env:
          BUMP_TYPE: ${{ steps.bump-type.outputs.bump_type }}
          LATEST_TAG: ${{ steps.bump-type.outputs.latest_tag }}
        run: |
          set -eu
          latest_tag="${LATEST_TAG}"

          if ! printf '%s' "$latest_tag" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Latest tag '$latest_tag' is not SemVer (vMAJOR.MINOR.PATCH)."
            exit 1
          fi

          if [ "$latest_tag" != "v0.0.0" ] && [ "$(git rev-list -n 1 "$latest_tag")" = "$(git rev-parse HEAD)" ]; then
            echo "No new commits since $latest_tag. Skipping tag creation."
            {
              echo "skip=true"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          version="${latest_tag#v}"
          IFS='.' read -r major minor patch <<< "$version"

          case "$BUMP_TYPE" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
            *)
              echo "Unsupported bump type: $BUMP_TYPE"
              exit 1
              ;;
          esac

          new_version="v${major}.${minor}.${patch}"

          if git rev-parse "$new_version" >/dev/null 2>&1; then
            echo "Tag $new_version already exists."
            exit 1
          fi

          {
            echo "skip=false"
            echo "new_version=$new_version"
            echo "latest_tag=$latest_tag"
          } >> "$GITHUB_OUTPUT"

      - name: Create and push tag
        if: steps.version.outputs.skip != 'true'
        env:
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
          PUSH_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          set -eu
          if [ -z "${PUSH_TOKEN}" ]; then
            echo "HOMEBREW_TAP_GITHUB_TOKEN is required to push tags and trigger Release workflow."
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
          git push origin "$NEW_VERSION"
